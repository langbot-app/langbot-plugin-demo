# Auto generated by LangBot Plugin SDK.
# Please refer to https://docs.langbot.app/en/plugin/dev/tutor.html for more details.
from __future__ import annotations

import json
from typing import Any
import httpx
import logging
import traceback
from langbot_plugin.api.definition.components.knowledge_retriever.retriever import KnowledgeRetriever
from langbot_plugin.api.entities.builtin.provider.message import ContentElement
from langbot_plugin.api.entities.builtin.rag.context import RetrievalContext, RetrievalResultEntry


logger = logging.getLogger(__name__)


class DifyDatasets(KnowledgeRetriever):

    async def retrieve(self, context: RetrievalContext) -> list[RetrievalResultEntry]:
        """Retrieve knowledge from Dify datasets"""

        # Get configuration values
        api_base_url = self.config.get('api_base_url', 'https://api.dify.ai/v1')
        api_key = self.config.get('dify_apikey')
        dataset_id = self.config.get('dataset_id')
        top_k = self.config.get('top_k', 5)
        score_threshold = self.config.get('score_threshold', 0.5)
        search_method = self.config.get('search_method', 'keyword_search')

        if not api_key or not dataset_id:
            logger.error("Missing required configuration: dify_apikey or dataset_id")
            return []

        # Remove trailing slash from base URL if present
        api_base_url = api_base_url.rstrip('/')

        # Prepare the API request
        url = f"{api_base_url}/datasets/{dataset_id}/retrieve"
        headers = {
            "Authorization": f"Bearer {api_key}",
            "Content-Type": "application/json"
        }

        payload = {
            "query": context.query,
            "retrieval_model": {
                "search_method": search_method,
                "reranking_enable": False,
                "reranking_mode": None,
                "reranking_model": {
                    "reranking_provider_name": "",
                    "reranking_model_name": ""
                },
                "weights": None,
                "top_k": int(top_k),
                "score_threshold_enabled": True,
                "score_threshold": float(score_threshold)
            }
        }

        try:
            # Make the API request
            async with httpx.AsyncClient() as client:
                response = await client.post(url, json=payload, headers=headers, timeout=30.0)
                response.raise_for_status()

                data = response.json()

                # Parse the response and convert to RetrievalResultEntry
                results = []
                for record in data.get('records', []):
                    segment = record.get('segment', {})
                    document = segment.get('document', {})

                    entry = RetrievalResultEntry(
                        id=segment.get('id', ''),
                        content=[ContentElement.from_text(segment.get('content', ''))],
                        metadata={
                            'document_id': segment.get('document_id', ''),
                            'document_name': document.get('name', ''),
                            'segment_id': segment.get('id', ''),
                            'keywords': segment.get('keywords', []),
                            'answer': segment.get('answer'),
                        },
                        distance=1.0 - float(record.get('score', 0.0)) if record.get('score') is not None else 0.5,
                    )
                    results.append(entry)

                logger.info(f"Retrieved {len(results)} chunks from Dify dataset {dataset_id}")
                return results

        except httpx.HTTPStatusError as e:
            logger.error(f"HTTP error from Dify API: {e.response.status_code} - {e.response.text}")
            return []
        except httpx.RequestError as e:
            logger.error(f"Request error when calling Dify API: {str(e)}")
            return []
        except Exception as e:
            traceback.print_exc()
            logger.error(f"Unexpected error during retrieval: {str(e)}")
            return []