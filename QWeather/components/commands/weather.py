# Auto generated by LangBot Plugin SDK.
# Please refer to https://docs.langbot.app/en/plugin/dev/tutor.html for more details.
from __future__ import annotations

from typing import Any, AsyncGenerator
import sys
import logging
from pathlib import Path
import traceback

from langbot_plugin.api.definition.components.command.command import Command, Subcommand
from langbot_plugin.api.entities.builtin.command.context import ExecuteContext, CommandReturn
from langbot_plugin.api.entities.builtin.command.errors import CommandError


logger = logging.getLogger(__name__)


class Weather(Command):

    def __init__(self):
        super().__init__()

        @self.subcommand(
            name="*",
            help="Display weather information for a city",
            usage="weather <city_name>",
            aliases=["å¤©æ°”"],
        )
        async def get_weather(self, context: ExecuteContext) -> AsyncGenerator[CommandReturn, None]:
            """Get weather information for a city"""
            if not context.crt_params:
                yield CommandReturn(
                    text="è¯·æä¾›åŸå¸‚åç§°ï¼Œä¾‹å¦‚: !weather åŒ—äº¬",
                )
                return

            city = context.crt_params[0]
            config = self.plugin.get_config()

            try:
                # Use QWeather API to get weather data
                weather_text = await self._get_qweather_text(city, config)

                if weather_text:
                    yield CommandReturn(
                        text=weather_text,
                    )
                else:
                    yield CommandReturn(
                        error=CommandError("å¤©æ°”ä¿¡æ¯è·å–å¤±è´¥ï¼Œè¯·æ£€æŸ¥åŸå¸‚åç§°æ˜¯å¦æ­£ç¡®"),
                    )
            except Exception as e:
                logger.error(f"è·å–å¤©æ°”ä¿¡æ¯å¤±è´¥: {str(e)}")
                traceback.print_exc()
                yield CommandReturn(
                    error=CommandError(f"è·å–å¤©æ°”ä¿¡æ¯å¤±è´¥: {str(e)}")
                )

    async def _get_qweather_text(self, city: str, config: dict) -> str:
        """Get weather using QWeather API and format as text"""
        try:
            # Import local modules
            plugin_path = Path(__file__).parent.parent.parent
            if str(plugin_path) not in sys.path:
                sys.path.insert(0, str(plugin_path))

            from pkg.weather_data import Weather as WeatherData, CityNotFoundError

            api_key = config.get('qweather_apikey', '')
            api_type = int(config.get('qweather_apitype', '0'))

            if not api_key:
                raise ValueError("æœªé…ç½®å’Œé£å¤©æ°” API Keyï¼Œè¯·åœ¨æ’ä»¶é…ç½®ä¸­å¡«å†™")

            # Get weather data
            w_data = WeatherData(city_name=city, api_key=api_key, api_type=api_type)
            w_data.load_data()

            # Format as text
            weather_text = self._format_weather_text(w_data)
            return weather_text

        except CityNotFoundError:
            logger.error(f"City not found: {city}")
            return ''
        except Exception as e:
            logger.error(f"QWeather API error: {str(e)}")
            raise

    def _format_weather_text(self, weather) -> str:
        """Format weather data as text"""
        lines = []
        lines.append(f"ğŸ“ {weather.city_name} å¤©æ°”ä¿¡æ¯")
        lines.append("")

        # Current weather
        now = weather.now.now
        lines.append(f"ğŸŒ¡ï¸ å½“å‰å¤©æ°”")
        lines.append(f"  æ¸©åº¦: {now.temp}Â°C")
        lines.append(f"  å¤©æ°”: {now.text}")
        lines.append(f"  é£å‘: {now.windDir} {now.windScale}çº§")
        lines.append(f"  æ¹¿åº¦: {now.humidity}%")
        lines.append(f"  èƒ½è§åº¦: {now.vis}km")
        lines.append("")

        # Air quality
        if weather.air and weather.air.now:
            air = weather.air.now
            lines.append(f"ğŸ’¨ ç©ºæ°”è´¨é‡")
            lines.append(f"  AQI: {air.aqi} ({air.category})")
            lines.append(f"  PM2.5: {air.pm2p5}")
            lines.append("")

        # Forecast
        if weather.daily and weather.daily.daily:
            lines.append(f"ğŸ“… æœªæ¥{len(weather.daily.daily)}å¤©é¢„æŠ¥")
            for day in weather.daily.daily[:3]:  # Show first 3 days
                lines.append(f"  {day.fxDate}: {day.textDay} {day.tempMin}~{day.tempMax}Â°C")
            lines.append("")

        # Weather warnings
        if weather.warning and weather.warning.warning:
            lines.append(f"âš ï¸ å¤©æ°”é¢„è­¦")
            for warn in weather.warning.warning:
                lines.append(f"  {warn.type}: {warn.title}")
            lines.append("")

        # Sun times
        if weather.sun:
            lines.append(f"ğŸŒ… æ—¥å‡ºæ—¥è½")
            lines.append(f"  æ—¥å‡º: {weather.sun.sunrise}")
            lines.append(f"  æ—¥è½: {weather.sun.sunset}")

        return "\n".join(lines)
